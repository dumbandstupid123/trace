<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trace</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: monospace;
      padding: 48px 24px;
      gap: 32px;
    }
    h1 { font-weight: 400; letter-spacing: 0.1em; color: #111; font-size: 2rem; }
    .tabs { display: flex; border: 1px solid #111; }
    .tab {
      padding: 10px 32px;
      cursor: pointer;
      background: #fff;
      border: none;
      font-family: monospace;
      font-size: 0.9rem;
      letter-spacing: 0.05em;
    }
    .tab.active { background: #111; color: #fff; }
    .panel { display: none; flex-direction: column; align-items: center; gap: 16px; width: 100%; max-width: 820px; }
    .panel.active { display: flex; }
    .upload-box {
      border: 1px solid #111;
      padding: 48px 64px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      width: 100%;
    }
    .upload-box:hover { background: #f5f5f5; }
    button {
      background: #111;
      color: #fff;
      border: none;
      padding: 12px 32px;
      font-family: monospace;
      font-size: 1rem;
      cursor: pointer;
      letter-spacing: 0.05em;
    }
    button:hover { background: #333; }
    textarea {
      width: 100%;
      height: 100px;
      font-family: monospace;
      font-size: 0.9rem;
      padding: 16px;
      border: 1px solid #111;
      resize: none;
      outline: none;
    }
    #status1, #status2 { color: #666; font-size: 0.9rem; }
    #output {
      white-space: pre;
      background: #f5f5f5;
      padding: 24px;
      width: 100%;
      max-height: 400px;
      overflow: auto;
      font-size: 0.8rem;
      display: none;
    }
    #schematic { display: none; width: 100%; border: 1px solid #f0f0f0; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; display: none; }
    th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; font-size: 0.85rem; }
    th { background: #111; color: #fff; }
    tr:nth-child(even) { background: #f5f5f5; }
    a { color: #111; }
    .loader { display: none; width: 200px; height: 80px; }
    .loader.active { display: block; }
    .wire {
      stroke: #111;
      stroke-width: 2;
      fill: none;
      stroke-dasharray: 300;
      stroke-dashoffset: 300;
      animation: drawWire 1.5s ease-in-out infinite;
    }
    .pulse {
      fill: #111;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes drawWire {
      0% { stroke-dashoffset: 300; }
      50% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: -300; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.2; r: 3; }
      50% { opacity: 1; r: 5; }
    }
    footer {
      color: #aaa;
      font-size: 0.8rem;
      text-align: center;
      padding-bottom: 24px;
      margin-top: auto;
    }
    footer a { color: #aaa; }
  </style>
</head>
<body>
  <h1>trace</h1>

  <div class="tabs">
    <button class="tab active" onclick="switchTab(1)">datasheet → zener</button>
    <button class="tab" onclick="switchTab(2)">natural language → schematic</button>
  </div>

  <!-- Panel 1: Datasheet to Zener -->
  <div class="panel active" id="panel1">
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <p>drop a datasheet</p>
      <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="handleFile(this)">
      <span id="filename" style="color:#666">no file selected</span>
    </div>
    <button onclick="runAgent()">generate zener</button>
    <p id="status1"></p>
    <svg class="loader" id="loader1" viewBox="0 0 200 80">
      <path class="wire" d="M 10 40 L 40 40 L 40 20 L 80 20 L 80 60 L 120 60 L 120 20 L 160 20 L 160 40 L 190 40"/>
      <circle class="pulse" cx="10" cy="40" r="3"/>
      <circle class="pulse" cx="190" cy="40" r="3" style="animation-delay: 0.75s"/>
    </svg>
    <pre id="output"></pre>
  </div>

  <!-- Panel 2: Natural Language to Schematic -->
  <div class="panel" id="panel2">
    <p style="color:#666; font-size:0.85rem; text-align:center; max-width:500px; line-height:1.6;">
      ask Trace to build out a rough sketch of any electronic design you're curious to prototype. Use the sketch and BOM as a starting ground!
    </p>
    <textarea id="nlInput" placeholder="e.g. I want a battery-powered ESP32 board with USB charging and an IMU"></textarea>
    <button onclick="runSchematic()">generate schematic</button>
    <p id="status2"></p>
    <svg class="loader" id="loader2" viewBox="0 0 200 80">
      <path class="wire" d="M 10 40 L 40 40 L 40 20 L 80 20 L 80 60 L 120 60 L 120 20 L 160 20 L 160 40 L 190 40"/>
      <circle class="pulse" cx="10" cy="40" r="3"/>
      <circle class="pulse" cx="190" cy="40" r="3" style="animation-delay: 0.75s"/>
    </svg>
    <svg id="schematic" height="700"></svg>
    <table id="bom">
      <thead>
        <tr>
          <th>Ref</th>
          <th>Component</th>
          <th>Value</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Total</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="bomBody"></tbody>
    </table>
  </div>

  <footer>
    built by sandeep ramlochan — reach out to <a href="mailto:sr185@rice.edu">sr185@rice.edu</a> with questions
  </footer>

  <script>
    let selectedFile = null;

    function switchTab(n) {
      document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === n-1));
      document.querySelectorAll('.panel').forEach((p, i) => p.classList.toggle('active', i === n-1));
    }

    function handleFile(input) {
      selectedFile = input.files[0];
      document.getElementById('filename').textContent = selectedFile.name;
    }

    async function runAgent() {
      if (!selectedFile) { document.getElementById('status1').textContent = 'upload a datasheet first'; return; }
      document.getElementById('status1').textContent = 'generating...';
      document.getElementById('output').style.display = 'none';
      document.getElementById('loader1').classList.add('active');

      const formData = new FormData();
      formData.append('file', selectedFile);

      try {
        const res = await fetch('http://localhost:5700/generate', { method: 'POST', body: formData });
        const data = await res.json();
        document.getElementById('loader1').classList.remove('active');
        if (data.success) {
          document.getElementById('status1').textContent = 'done!';
          document.getElementById('output').textContent = data.code;
          document.getElementById('output').style.display = 'block';
        } else {
          document.getElementById('status1').textContent = 'failed: ' + data.error;
        }
      } catch (err) {
        document.getElementById('loader1').classList.remove('active');
        document.getElementById('status1').textContent = 'error: ' + err.message;
      }
    }

    async function runSchematic() {
      const prompt = document.getElementById('nlInput').value;
      if (!prompt) { document.getElementById('status2').textContent = 'enter a description first'; return; }
      document.getElementById('status2').textContent = 'generating...';
      document.getElementById('schematic').style.display = 'none';
      document.getElementById('bom').style.display = 'none';
      document.getElementById('loader2').classList.add('active');

      try {
        const res = await fetch('http://localhost:5700/schematic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        document.getElementById('loader2').classList.remove('active');

        if (data.success) {
          document.getElementById('status2').textContent = 'done!';
          drawSchematic(data.data.components, data.data.connections);
          drawBOM(data.data.bom);
        } else {
          document.getElementById('status2').textContent = 'failed: ' + data.error;
        }
      } catch (err) {
        document.getElementById('loader2').classList.remove('active');
        document.getElementById('status2').textContent = 'error: ' + err.message;
      }
    }

    function drawSchematic(components, connections) {
      const svg = document.getElementById('schematic');
      svg.innerHTML = '';
      svg.style.display = 'block';

      const W = 140, H = 55;
      const svgW = 820, svgH = 700;
      svg.setAttribute('height', svgH);
      svg.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);

      const mainIdx = components.findIndex(c => c.type === 'ic');
      const main = components[mainIdx !== -1 ? mainIdx : 0];
      const others = components.filter(c => c !== main);

      main.x = svgW / 2 - W / 2;
      main.y = svgH / 2 - H / 2;

      others.forEach((comp, i) => {
        const angle = (i / others.length) * 2 * Math.PI - Math.PI / 2;
        const rx = 290, ry = 230;
        comp.x = svgW / 2 + rx * Math.cos(angle) - W / 2;
        comp.y = svgH / 2 + ry * Math.sin(angle) - H / 2;
      });

      // Draw ALL connections
      connections.forEach(conn => {
        const from = components.find(c => c.id === conn.from);
        const to = components.find(c => c.id === conn.to);
        if (!from || !to) return;

        const x1 = from.x + W / 2;
        const y1 = from.y + H / 2;
        const x2 = to.x + W / 2;
        const y2 = to.y + H / 2;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', '#e0e0e0');
        line.setAttribute('stroke-width', '1.5');
        svg.appendChild(line);

        if (conn.label) {
          const lx = x1 + (x2 - x1) * 0.35;
          const ly = y1 + (y2 - y1) * 0.35 - 5;
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', lx);
          text.setAttribute('y', ly);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '8');
          text.setAttribute('fill', '#bbb');
          text.setAttribute('font-family', 'monospace');
          text.textContent = conn.label.length > 12 ? conn.label.substring(0, 12) + '..' : conn.label;
          svg.appendChild(text);
        }
      });

      // Draw components on top
      components.forEach(comp => {
        const isMain = comp === main;
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', comp.x);
        rect.setAttribute('y', comp.y);
        rect.setAttribute('width', W);
        rect.setAttribute('height', H);
        rect.setAttribute('fill', isMain ? '#111' : '#fff');
        rect.setAttribute('stroke', '#111');
        rect.setAttribute('stroke-width', '1.5');
        rect.setAttribute('rx', '4');
        g.appendChild(rect);

        const id = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        id.setAttribute('x', comp.x + W / 2);
        id.setAttribute('y', comp.y + 22);
        id.setAttribute('text-anchor', 'middle');
        id.setAttribute('font-size', '13');
        id.setAttribute('font-family', 'monospace');
        id.setAttribute('font-weight', 'bold');
        id.setAttribute('fill', isMain ? '#fff' : '#111');
        id.textContent = comp.id;
        g.appendChild(id);

        const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        name.setAttribute('x', comp.x + W / 2);
        name.setAttribute('y', comp.y + 38);
        name.setAttribute('text-anchor', 'middle');
        name.setAttribute('font-size', '9');
        name.setAttribute('font-family', 'monospace');
        name.setAttribute('fill', isMain ? '#aaa' : '#666');
        name.textContent = comp.name.length > 18 ? comp.name.substring(0, 18) + '..' : comp.name;
        g.appendChild(name);

        svg.appendChild(g);
      });
    }

    function drawBOM(bom) {
      const tbody = document.getElementById('bomBody');
      tbody.innerHTML = '';
      let total = 0;
      bom.forEach(row => {
        const lineTotal = (row.unit_price * row.qty).toFixed(2);
        total += parseFloat(lineTotal);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.ref}</td>
          <td><a href="${row.url}" target="_blank">${row.component}</a></td>
          <td>${row.value}</td>
          <td>${row.qty}</td>
          <td>$${row.unit_price.toFixed(2)}</td>
          <td>$${lineTotal}</td>
          <td>${row.notes}</td>`;
        tbody.appendChild(tr);
      });
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5"><strong>Total</strong></td><td><strong>$${total.toFixed(2)}</strong></td><td></td>`;
      tbody.appendChild(tr);
      document.getElementById('bom').style.display = 'table';
    }
  </script>
</body>
</html>